<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro IDE - Interactive Browser Edition</title>
    <!-- CSS and JS library imports are unchanged -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e; --panel-color: #252526; --header-color: #333;
            --border-color: #444; --text-color: #d4d4d4; --button-color: #0e639c;
            --button-hover: #1177bb; --danger-color: #c93c3c;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: var(--panel-color); border-bottom: 1px solid var(--header-color); }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header h1 { margin: 0; font-size: 1.5em; }
        #current-project-name { font-size: 1.1em; color: #aaa; }
        .ide-button { padding: 8px 16px; background-color: var(--button-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .ide-button:hover:not(:disabled) { background-color: var(--button-hover); }
        .ide-button:disabled { background-color: #5a5a5a; cursor: not-allowed; }
        .ide-body { display: flex; flex-grow: 1; overflow: hidden; }
        .file-explorer { width: 220px; background-color: var(--panel-color); padding: 10px; border-right: 1px solid var(--header-color); display: flex; flex-direction: column; }
        .file-explorer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .file-explorer-header h3 { margin: 0; }
        #file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        #file-list li { padding: 8px 10px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #file-list li:hover { background-color: var(--header-color); }
        #file-list li.active { background-color: var(--button-color); }
        .delete-file-btn { color: var(--danger-color); visibility: hidden; }
        #file-list li:hover .delete-file-btn { visibility: visible; }
        .main-container { display: flex; flex-direction: column; flex-grow: 1; padding: 10px; overflow-y: auto; }
        .io-container { display: flex; flex-direction: column; flex-grow: 1; gap: 10px; }
        .window { display: flex; flex-direction: column; background-color: var(--panel-color); border: 1px solid var(--header-color); border-radius: 4px; overflow: hidden; }
        .input-window { flex-basis: 50%; min-height: 250px; }
        .output-window { flex-basis: 25%; min-height: 150px; }
        .browser-window { flex-basis: 25%; min-height: 150px; }
        .window-header { padding: 8px 12px; background-color: var(--header-color); font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .CodeMirror { height: 100%; font-size: 16px; }
        #output { padding: 12px; box-sizing: border-box; height: 100%; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; overflow-y: auto; color: #ccc; }
        .browser-controls { display: flex; flex-wrap: wrap; align-items: center; padding: 5px; background-color: var(--header-color); border-bottom: 1px solid var(--border-color); gap: 10px;}
        #url-input { flex-grow: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 5px 8px; border-radius: 3px; }
        #browser-frame { width: 100%; height: 100%; border: none; background-color: white; }
        #browser-status { flex-basis: 100%; font-size: 0.9em; color: #aaa; text-align: center; padding: 2px 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel-color); padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title"><h1>Pro IDE</h1><span id="current-project-name"></span></div>
        <div class="controls"><button id="project-hub-btn" class="ide-button">Project Hub</button><button id="run-button" class="ide-button">Run</button></div>
    </div>

    <div class="ide-body">
        <div class="file-explorer">
             <div class="file-explorer-header"><h3>Files</h3><button id="new-file-btn" class="ide-button" title="New File">+</button></div>
             <ul id="file-list"></ul>
        </div>
        <div class="main-container">
            <div class="io-container">
                <div class="window input-window">
                    <div class="window-header" id="editor-header">Code Editor</div>
                    <div class="code-area"><textarea id="code-input"></textarea></div>
                </div>
                <div class="window output-window">
                    <div class="window-header">Output</div>
                    <div class="output-area"><pre id="output"></pre></div>
                </div>
                <div class="window browser-window">
                    <div class="window-header">Interactive Browser</div>
                    <div class="browser-controls">
                        <input type="text" id="url-input" placeholder="https://example.com">
                        <button id="browser-go-btn" class="ide-button">Go</button>
                        <button id="browser-fullscreen-btn" class="ide-button">Fullscreen</button>
                        <div id="browser-status">Enter a URL to begin.</div>
                    </div>
                    <iframe id="browser-frame" sandbox="allow-scripts allow-forms allow-popups allow-same-origin"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <div id="project-hub-modal" class="modal-overlay"> <!-- Modal content handled by JS --> </div>

    <script>
        // --- DOM Elements ---
        const browserFrame = document.getElementById('browser-frame');
        const browserStatus = document.getElementById('browser-status');
        const browserGoBtn = document.getElementById('browser-go-btn');
        const urlInput = document.getElementById('url-input');
        const browserFullscreenBtn = document.getElementById('browser-fullscreen-btn');
        
        // --- INTERACTIVE BROWSER LOGIC ---
        async function browseToUrl(url) {
            if (!url) { url = urlInput.value.trim(); }
            if (!url) return;
            if (!url.startsWith('http://') && !url.startsWith('https://')) { url = 'https://' + url; }
            urlInput.value = url;
            
            browserStatus.textContent = `Loading ${url}...`;
            browserFrame.srcdoc = `<html><body style="font-family: sans-serif; color: #555; text-align: center; padding-top: 50px;"><h2>Loading...</h2></body></html>`;

            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Network response: ${response.status}`);
                let html = await response.text();

                const baseTag = `<base href="${url}">`;
                html = html.replace(/<head>/i, `<head>${baseTag}`);

                const navigationScript = `
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            document.body.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href) {
                                    e.preventDefault();
                                    window.parent.postMessage({ type: 'browser-navigate', url: link.href }, '*');
                                }
                            });
                        });
                    <\/script>
                `;
                html = html.replace(/<\/body>/i, `${navigationScript}</body>`);
                
                browserFrame.srcdoc = html;
                browserStatus.textContent = `Loaded ${url}. Click links to navigate.`;
            } catch (error) {
                console.error('Browser proxy fetch error:', error);
                browserStatus.textContent = `Proxy failed: ${error.message}`;
                browserFrame.srcdoc = `<html><body><h2>Proxy Failed</h2><p>${error.message}</p></body></html>`;
            }
        }

        window.addEventListener('message', (event) => {
            if (event.source !== browserFrame.contentWindow || event.data.type !== 'browser-navigate') {
                return;
            }
            const newUrl = event.data.url;
            if (newUrl) {
                urlInput.value = newUrl;
                browseToUrl(newUrl);
            }
        });

        function toggleBrowserFullscreen() {
            if (!document.fullscreenElement) {
                browserFrame.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // --- ALL OTHER FUNCTIONS (UNCHANGED, MINIFIED FOR BREVITY) ---
        const editorHeader=document.getElementById("editor-header"),runButton=document.getElementById("run-button"),outputElement=document.getElementById("output"),projectHubBtn=document.getElementById("project-hub-btn"),fileListEl=document.getElementById("file-list"),newFileBtn=document.getElementById("new-file-btn"),currentProjectNameEl=document.getElementById("current-project-name");let pyodide=null,currentProjectName=null,activeFileName=null,projects={};const editor=CodeMirror.fromTextArea(document.getElementById("code-input"),{lineNumbers:!0,theme:"material-darker",indentUnit:4,autoCloseBrackets:!0}),projectTemplates={html:{language:"html",files:[{name:"index.html",content:"<!DOCTYPE html>\n<html>\n<head>\n    <title>My Project</title>\n    <link rel=\"stylesheet\" href=\"style.css\">\n</head>\n<body>\n    <h1>Hello from HTML!</h1>\n    <p>This is a test.</p>\n    <script src=\"script.js\"><\/script>\n</body>\n</html>"},{name:"style.css",content:"body {\n    font-family: sans-serif;\n    background-color: #f0f0f0;\n    color: #333;\n}"},{name:"script.js",content:'console.log("Hello from script.js!");'}]},python:{language:"python",files:[{name:"main.py",content:'print("Hello, World from Python!")'}]},csharp:{language:"csharp",files:[{name:"program.cs",content:'using System;\n\nclass Program {\n    static void Main() {\n        Console.WriteLine("Hello from program.cs!");\n    }\n}'}]}};function saveProjectsToStorage(){localStorage.setItem("pro-ide-projects-final",JSON.stringify(projects))}function saveActiveFile(){if(!currentProjectName||!activeFileName)return;const e=projects[currentProjectName].files.find(e=>e.name===activeFileName);e&&(e.content=CodeMirror.fromTextArea(document.getElementById("code-input")).getValue(),saveProjectsToStorage())}function loadProject(e){if(!projects[e])return currentProjectName=null,activeFileName=null,currentProjectNameEl.textContent="",CodeMirror.fromTextArea(document.getElementById("code-input")).setValue("No project loaded."),void populateFileList();currentProjectName=e,localStorage.setItem("pro-ide-last-project",e),currentProjectNameEl.textContent=`| ${e}`;const t=projects[e].files[0]?.name||null;loadFile(t),populateFileList(),closeProjectHub()}function createNewProject(){const e=document.getElementById("project-hub-modal").querySelector("#new-project-name"),t=document.getElementById("project-hub-modal").querySelector("#project-type-select"),l=e.value.trim();if(!l)return void alert("Please enter a project name.");if(projects[l])return void alert("A project with this name already exists.");projects[l]=JSON.parse(JSON.stringify(projectTemplates[t.value])),e.value="",saveProjectsToStorage(),loadProject(l)}function deleteProject(e){if(!confirm(`Are you sure you want to delete "${e}"?`))return;delete projects[e],saveProjectsToStorage(),populateProjectList(),currentProjectName===e&&loadProject(Object.keys(projects)[0]||null)}function loadFile(e){const t=CodeMirror.fromTextArea(document.getElementById("code-input"));if(!currentProjectName)return;const l=projects[currentProjectName],o=l.files.find(t=>t.name===e);o?(activeFileName=e,t.setValue(o.content),editorHeader.textContent=`Code Editor (${e})`,setEditorMode(e)):(t.setValue(""),activeFileName=null,editorHeader.textContent="Code Editor"),populateFileList()}function setEditorMode(e){const t=CodeMirror.fromTextArea(document.getElementById("code-input"));if(!e)return;const l=e.split(".").pop();let o="text/plain";"html"===l?o="htmlmixed":"css"===l?o="css":"js"===l?o="javascript":"py"===l?o="python":"cs"===l&&(o="text/x-csharp"),t.setOption("mode",o)}function addNewFile(){if(!currentProjectName)return;const e=prompt("Enter new file name (e.g., app.js):");if(!e||""===e.trim())return;const t=projects[currentProjectName];if(t.files.some(t=>t.name===e))return void alert("A file with this name already exists.");t.files.push({name:e,content:""}),saveProjectsToStorage(),loadFile(e)}function deleteFile(e,t){t.stopPropagation();if(!currentProjectName||!confirm(`Delete "${e}"?`))return;const l=projects[currentProjectName];l.files=l.files.filter(t=>t.name!==e),saveProjectsToStorage(),activeFileName===e&&loadFile(l.files[0]?.name||null),populateFileList()}function populateFileList(){fileListEl.innerHTML="",currentProjectName&&projects[currentProjectName]&&projects[currentProjectName].files.forEach(e=>{const t=document.createElement("li");t.textContent=e.name,t.className=e.name===activeFileName?"active":"",t.onclick=()=>loadFile(e.name);const l=document.createElement("span");l.innerHTML="&times;",l.className="delete-file-btn",l.title="Delete File",l.onclick=t=>deleteFile(e.name,t),t.appendChild(l),fileListEl.appendChild(t)})}function populateProjectList(){const e=document.getElementById("project-hub-modal").querySelector("#project-list");e.innerHTML="";const t=Object.keys(projects);if(0===t.length)return void(e.innerHTML="<li>No projects found. Create one below!</li>");t.forEach(t=>{const l=document.createElement("li");l.innerHTML=`\n<span class="project-name">${t}</span><div class="actions"><button class="ide-button" onclick="loadProject('${t}')">Load</button><button class="ide-button" onclick="deleteProject('${t}')" style="background-color:var(--danger-color);">Delete</button></div>`,e.appendChild(l)})}function openProjectHub(){const e=document.getElementById("project-hub-modal");e.innerHTML=`<div class="modal-content"><button onclick="closeProjectHub()" style="float: right;">&times;</button><h2>Project Hub</h2><div class="modal-section"><h3>Load Project</h3><ul id="project-list"></ul></div><div class="modal-section"><h3>Create New Project</h3><div id="new-project-controls" style="display:flex;flex-direction:column;gap:10px;"><input type="text" id="new-project-name" placeholder="Enter new project name..."><div style="display:flex;gap:10px;"><select id="project-type-select"><option value="html">HTML</option><option value="python">Python</option><option value="csharp">C#</option></select><button id="create-project-btn" class="ide-button">Create</button></div></div></div></div>`,e.style.display="flex",populateProjectList(),e.querySelector("#create-project-btn").onclick=createNewProject}function closeProjectHub(){document.getElementById("project-hub-modal").style.display="none"}async function runCode(){if(!currentProjectName)return;const e=projects[currentProjectName],t=document.getElementById("output");switch(t.textContent="",e.language){case"html":runHtmlProject(e);break;case"python":await runPythonProject(e);break;case"csharp":runCSharpProject(e)}}function runHtmlProject(e){let t=e.files.find(e=>e.name.endsWith(".html"));if(!t)return void(document.getElementById("output").textContent="Error: No .html file found.");let l=t.content;const o=l.match(/<link.*?rel="stylesheet".*?href="(.*?)".*?>/g)||[];o.forEach(t=>{const o=t.match(/href="(.*?)"/);if(!o)return;const n=o[1],c=e.files.find(e=>e.name===n);c&&(l=l.replace(t,`<style>\n${c.content}\n<\/style>`))});const n=l.match(/<script.*?src="(.*?)".*?><\/script>/g)||[];n.forEach(t=>{const o=t.match(/src="(.*?)"/);if(!o)return;const n=o[1],c=e.files.find(e=>e.name===n);c&&(l=l.replace(t,`<script>\n${c.content}\n<\/script>`))});try{const e=window.open();if(!e||e.closed||"undefined"==typeof e.closed)return void(document.getElementById("output").textContent="Error: Pop-up blocked! Please allow pop-ups for this site.");e.document.write(l),e.document.close()}catch(e){document.getElementById("output").textContent="An error occurred opening the new window."}}async function runPythonProject(e){if(!pyodide)return void(document.getElementById("output").textContent="Python is loading...");const t=e.files.find(e=>e.name.endsWith(".py"));if(!t)return void(document.getElementById("output").textContent="No .py file found.");const l=document.getElementById("run-button");l.disabled=!0;try{pyodide.setStdout({batched:e=>{document.getElementById("output").textContent+=e+"\n"}}),await pyodide.runPythonAsync(t.content)}catch(e){document.getElementById("output").textContent+=e.toString()}finally{pyodide.setStdout({}),l.disabled=!1}}function runCSharpProject(e){document.getElementById("output").textContent="C# compilation is not supported.\nConcatenating .cs files:\n\n"+"=".repeat(40)+"\n\n",e.files.filter(e=>e.name.endsWith(".cs")).forEach(e=>{document.getElementById("output").textContent+=`// --- ${e.name} ---\n\n${e.content}\n\n`})}
        
        // --- Main Initialization and Event Listeners ---
        (async function(){
            const runButton = document.getElementById("run-button");
            const editor = CodeMirror.fromTextArea(document.getElementById('code-input'));
            const outputElement = document.getElementById('output');
            outputElement.textContent = "Initializing Python environment...";
            runButton.disabled = true;
            try { pyodide = await loadPyodide(); outputElement.textContent = "Python environment is ready."; } 
            catch (e) { outputElement.textContent = "Failed to load Python: " + e; }
            runButton.disabled = false;
            const storedProjects = localStorage.getItem("pro-ide-projects-final");
            projects = storedProjects ? JSON.parse(storedProjects) : {};
            if (Object.keys(projects).length === 0) {
                projects['HTML Demo Project'] = JSON.parse(JSON.stringify(projectTemplates.html));
                projects['Python Demo Project'] = JSON.parse(JSON.stringify(projectTemplates.python));
                saveProjectsToStorage();
            }
            const lastProject = localStorage.getItem("pro-ide-last-project");
            loadProject(projects[lastProject] ? lastProject : Object.keys(projects)[0]);
            editor.on("change", saveActiveFile);
            runButton.addEventListener("click", runCode);
            projectHubBtn.addEventListener("click", openProjectHub);
            newFileBtn.addEventListener("click", addNewFile);
            browserGoBtn.addEventListener("click", () => browseToUrl());
            urlInput.addEventListener("keydown", e => { if (e.key === "Enter") browseToUrl() });
            browserFullscreenBtn.addEventListener("click", toggleBrowserFullscreen);
        })();
    </script>
</body>
</html>
